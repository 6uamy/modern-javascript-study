### 📎 목차

1. [동기 처리와 비동기 처리](#1-동기-처리와-비동기-처리)
2. [이벤트 루프와 태스크 큐](#2-이벤트-루프와-태스크-큐)

---

# 42장. 비동기 프로그래밍

## 1) **동기 처리와 비동기 처리**

> 📌 **23장 실행 컨텍스트 REVIEW**
>
> - 실행 컨텍스트 스택에 함수 실행 컨텍스트가 push 되는 것 ⇒ "함수의 시작"을 의미
> - 함수가 호출된 순서대로 순차적으로 실행되는 이유는 함수가 호출된 순서대로 함수 실행 컨텍스트가 실행 컨텍스트 스택에 push 되기 때문
> - 즉, 함수의 실행 순서는 실행 컨텍스트 스택으로 관리한다.

- **자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.**
  - 함수를 실행할 수 있는 창구가 단 하나이며, 동시에 2개 이상의 함수를 동시에 실행할 수 없다는 것을 의미
  - 실행 컨텍스트 스택의 최상위 요소인 "실행 중인 실행 컨텍스트"를 제외한 모든 실행 컨텍스트는 모두 실행 대기 중인 태스크(task)들이다.
  - 대기 중인 태스크들은 현재 실행 중인 실행 컨텍스트가 pop되어 실행 컨텍스트 스택에서 제거되면(실행 중인 함수가 종료되면), 비로소 실행되기 시작한다.
- **자바스크립트 엔진은 한 번에 하나의 태스크만 실행할 수 있는 싱글 스레드 방식으로 동작한다.**

<br/>

#### **◈ 싱글 스레드(single thread)**

- 한 번에 하나의 태스크만 실행할 수 있다.
- 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹(작업 중단)이 발생

<br/>

#### **◈ 동기(synchronous) 처리**

![3](https://github.com/hongii/book-shop-fe/assets/93701887/9ddf8be7-71f6-484e-b60c-1032c662d5d3)

- 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식
- 장점 : 태스크를 순서대로 하나씩 처리하므로 실행 순서가 보장됨
- 단점 : 태스크가 종료할 때까지 이후 태스크들이 블로킹됨

<br/>

#### **◈ 비동기(asynchronous) 처리**

![4](https://github.com/hongii/book-shop-fe/assets/93701887/11d63c44-bbd8-4bd3-8549-d53337543b12)

- 현재 실행 중인 태스크가 종료되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식
- 장점 : 블로킹이 발생하지 않음
- 단점 : 태스크 순서가 보장되지 않음
- `setTimeout`, `setInterval`, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작한다.

<br/><br/>

## 2) 이벤트 루프와 태스크 큐

- **자바스크립트는 싱글 스레드로 동작**하지만 브라우저가 동작하는 것을 보면 많은 태스크가 동시에 처리되는 것처럼 느껴진다.
  - 이처럼 자바스크립트의 동시성을 지원하는 것이 바로 **이벤트 루프(event loop)** 다.

![5](https://github.com/hongii/book-shop-fe/assets/93701887/501ab220-4e2e-47bd-a87a-e513498eacf0)

> 📌 **자바스크립트 엔진 ⇒ 2가지 영역으로 구분**
>
> - **콜 스택(call stack)**
>   - 소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택
>   - 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행
>   - 최상위 실행 컨텍스트(실행 중인 실행 컨텍스트)가 종료되어 콜 스택에서 제거되기 전까지 다른 어떤 태스크도 실행되지 않는다.
> - **힙(heap)**
>   - 객체가 저장되는 메모리 공간으로, 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조
>   - 메모리에 값을 저장하려면 먼저 값을 저장할 메모리 공간의 크기를 결정해야 한다.
>   - 객체는 원시 값과는 달리, 크기가 정해져 있지 않아서 할당해야 할 메모리 공간의 크기를 런타임에 결정(동적 할당)해야 한다.
>   - 힙은 구조화 되어있지 않다는 특징을 가짐

- 이와 같이 자바스크립트 엔진은 단순히 작업이 요청되면 콜 스택을 사용하여 요청된 작업을 순차적으로 실행할 뿐이다.
  - 비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 Node.js 가 담당
  - ex) 비동기 방식으로 동작하는 `setTimeout`
    - `setTimeout`의 콜백 함수의 평가와 실행은 자바스크립트 엔진이 담당
    - 호출 스케줄링을 위한 타이머 설정과 콜백 함수의 등록은 브라우저 또는 Node.js가 담당 ⇒ 이를 위해 **브라우저 환경은 태스크 큐와 이벤트 루프를 제공**

<br/>

### 📌 **브라우저 환경의 태스크 큐와 이벤트 루프**

![자료 출처 - https://dev.to/lydiahallie/javascript-visualized-promises-async-await-5gke#syntax](https://res.cloudinary.com/practicaldev/image/fetch/s--05Fi8vBq--/c_limit,f_auto,fl_progressive,q_66,w_880/https://dev-to-uploads.s3.amazonaws.com/i/42eatw03fcha0e1qcrf0.gif)

자료 출처 - https://dev.to/lydiahallie/javascript-visualized-promises-async-await-5gke#syntax

- **태스크 큐(task queue/event queue/callback queue)**
  - 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
  - cf) 태스크 큐(macrotask queue)와는 별도로 프로미스의 후속 처리 메서드의 콜백 함수가 일시적으로 보관되는 마이크로태스크 큐(microtask queue)도 존재함(45.7절 참고)
- **이벤트 루프(event loop)**
  - 콜 스택 내에 현재 실행중인 태스크가 있는지 그리고 태스크 큐에 대기 중인 함수(콜백 함수, 이벤트 핸들러 등)가 있는지 반복 확인
  - 만약 **콜 스택이 비어있고 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 순차적(FIFO)으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시키고, 콜 스택으로 이동한 함수는 실행**된다.
  - 태스크 큐에 일시 보관된 함수들은 비동기 처리 방식으로 동작

<br/>

#### **◈ 브라우저 환경에서의 비동기 함수 동작 예측하기**

```jsx
function foo() {
  console.log("foo");
}

function bar() {
  console.log("bar");
}

setTimeout(foo, 0); // 0초(실제로는 4ms) 후에 foo 함수 호출
bar();
```

1. 전역 코드가 평가되어 전역 실행 컨텍스트가 생성되고 콜 스택에 `push`
2. 전역 코드가 실행되기 시작하고, `setTimeout` 함수를 호출
   - 함수 실행 컨텍스트가 생성되고 콜 스택에 `push`되어 현재 실행 중인 실행 컨텍스트가 된다.
   - 브라우저의 Web API인 타이머 함수도 함수이므로 함수 실행 컨텍스트를 생성함
3. `setTimeout` 함수가 실행되면 콜백 함수를 호출 스케줄링하고 종료되어 콜 스택에서 `pop`
   - **이때 호출 스케줄링, 즉 타이머 설정과 타이머가 만료되면 콜백 함수를 태스크 큐에 `push`하는 것은 브라우저의 역할**
4. 브라우저가 수행하는 ⅰ 과정과 자바스크립트 엔진이 수행하는 ⅱ 과정은 **병행 처리**된다.
   - 브라우저와 자바스크립트 엔진이 협력하여 비동기 함수를 실행한다.
   1. **브라우저의 수행 과정**
      - **타이머를 설정하고 타이머의 만료를 기다린다.**
      - 이후 **타이머가 만료되면 4ms 후에 콜백 함수 `foo`가 태스크 큐에 `push`되어 대기하게 된다.**
      - cf) 태스크 큐에 `psuh`되어 대기하는 콜백 함수는 콜 스택이 비어야 호출되므로 `setTimeout` 함수로 호출 스케줄링한 콜백 함수는 정확히 지연 시간 후에 호출된다는 보장은 없다. ⇒ 약간의 시간차가 발생할 수 있음
   2. **자바스크립트 엔진의 수행 과정**
      - **`bar` 함수가 호출되어 `bar` 함수의 실행 컨텍스트가 생성되고 콜 스택에 `push`되어 현재 실행 중인 실행 컨텍스트가 된다.**
      - `bar`함수가 종료되면 콜 스택에서 `pop`
        - 이때 브라우저가 타이머를 설정한 후 4ms가 경과되었더라도 **`foo` 함수는 아직 태스크 큐에서 대기 중이다.**
5. 전역 코드 실행이 종료되고 전역 실행 컨텍스트가 콜 스택에서 `pop`
   - 콜 스택에는 아무런 실행 컨텍스트도 존재하지 않음
6. **이벤트 루프에 의해 콜 스택이 비어 있음이 감지**되고 **태스크 큐에서 대기 중인 콜백 함수 `foo`가 이벤트 루프에 의해 콜 스택에 push**
   1. 실행 중인 실행 컨텍스트가 되어 `foo` 함수가 실행
   2. `foo` 함수가 종료되면 콜 스택에서 `pop`

**⇒ 정리하자면, 비동기 함수인 `setTimeout`의 콜백 함수는 태스크 큐에 푸시되어 대기하다가 콜 스택이 비게 되면, 즉 전역 코드 및 명시적으로 호출된 함수가 모두 종료하면 비로소 콜 스택에 푸시되어 실행된다.**

> 🚨 **자바스크립트의 비동기 함수 처리에서 주의할 부분 짚고 넘어가기**
>
> - 브라우저에 내장된 **자바스크립트 엔진은 싱글 스레드로 동작**하지만, **브라우저는 자체는 멀티스레드로 동작**한다.
> - 따라서 자바스크립트의 비동기 함수 처리는 자바스크립트 엔진과 브라우저의 협동에 의해 처리된다.
>   - **자바스크립트 엔진에 의해 소스코드의 평가와 실행**이 이루어지고, **브라우저가 지원하는 이벤트 루프와 태스크 큐를 통해 비동기 함수 처리**가 가능
>   - 브라우저는 Web API를 제공하므로 다양한 비동기 함수를 실행할 수 있다.

<br/>

### 🌟 **자바스크립트 엔진 VS 브라우저**

|                        | 자바스크립트 엔진                                                                                              | 브라우저                                                                                                                      |
| ---------------------- | -------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| 동작 방식              | **싱글 스레드**로 동작                                                                                         | **멀티 스레드**로 동작                                                                                                        |
| 비동기 처리에서의 역할 | 소스코드의 평가와 실행 (ex. 콜백 함수의 평가과정을 통한 실행 컨텍스트의 생성 및 콜스택에 `push`하여 함수 실행) | 소스코드의 평가와 실행을 제외한 모든 처리(ex. 호출 스케줄링 ⇒ 타이머 설정과 타이머가 만료되면 콜백 함수를 태스크 큐에 `push`) |
| 비고                   | 브라우저에 내장되어 있음                                                                                       | 자바스크립트 엔진, 렌더링 엔진, Web API를 제공                                                                                |

- cf) Web API
  - ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API
  - DOM API와 타이머 함수, HTTP 요청(ajax)과 같은 비동기 처리를 포함
